---
name: ðŸŽ MacOS
on:
  push:
    branches:
      - main
      - create-pull-request/**
  pull_request:

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  build:
    permissions:
      contents: read
      packages: write
    strategy:
      matrix:
        include:
          - os: macos-15-intel
            triplet: x64-osx-dynamic
          - os: macos-15
            triplet: arm64-osx-dynamic
    env:
      buildtrees: /Users/runner/vcpkg-build
      FC: gfortran
      GCC_VERSION: 15

    name: build (macos)
    runs-on: ${{ matrix.os }}

    steps:
      - name: ðŸ£ Checkout
        uses: actions/checkout@v4

      - name: ðŸ© Install CMake and Ninja
        uses: lukka/get-cmake@latest

      - name: ðŸ”¨ Prepare build env
        run: |
          brew install autoconf automake autoconf-archive libtool mono swig bison flex

      - name: Symlink gfortran (macOS)
        if: matrix.os == 'macos-15'
        run: |
          # make sure gfortran is available
          # https://github.com/actions/runner-images/blob/main/images/macos/macos-15-Readme.md
          # https://github.com/actions/runner-images/issues/3371
          # ln version - new path 'MacOS14'
          sudo ln -fs /opt/homebrew/bin/gfortran-${GCC_VERSION} /usr/local/bin/gfortran
          sudo mkdir -p /usr/local/gfortran
          sudo ln -sf /opt/homebrew/Cellar/gcc@${GCC_VERSION}/*/lib/gcc/${GCC_VERSION} /usr/local/gfortran/lib

      - name: Symlink gfortran (macOS-intel)
        if: matrix.os == 'macos-15-intel'
        run: |
          # make sure gfortran is available
          # https://github.com/actions/runner-images/blob/main/images/macos/macos-15-Readme.md
          # https://github.com/actions/runner-images/issues/3371
          # ln version - new path 'MacOS14'
          sudo ln -fs /usr/local/bin/gfortran-${GCC_VERSION} /usr/local/bin/gfortran
          sudo mkdir -p /usr/local/gfortran
          sudo ln -sf /usr/local/Cellar/gcc@${GCC_VERSION}/*/lib/gcc/${GCC_VERSION} /usr/local/gfortran/lib

      - name: ðŸ• Checkout vcpkg
        uses: actions/checkout@v4
        with:
          repository: microsoft/vcpkg
          ref: 7c175421efa71616f86f7f02e053371a67e31bb2 # TODO: can we have a canonical baseline for tests?
          path: vcpkg
          fetch-depth: 1

      - name: ðŸ¾ Bootstrap vcpkg
        shell: bash
        run: |
          PKG_SOURCE_USER=$(echo $GITHUB_REPOSITORY | cut -d '/' -f 1)
          ./vcpkg/bootstrap-vcpkg.sh
          NUGET_EXE=$(./vcpkg/vcpkg fetch nuget | grep '^\/.*nuget.exe$')
          echo "Downloaded $NUGET_EXE"
          mono $NUGET_EXE sources add -Name ghpkg -Source "https://nuget.pkg.github.com/$PKG_SOURCE_USER/index.json" -UserName "$PKG_SOURCE_USER" -Password "${{ secrets.GITHUB_TOKEN }}" -StorePasswordInClearText
          mono $NUGET_EXE setapikey "${{ secrets.GITHUB_TOKEN }}" -Source "https://nuget.pkg.github.com/$PKG_SOURCE_USER/index.json"
          echo "VCPKG_BINARY_SOURCES=clear;nuget,https://nuget.pkg.github.com/$PKG_SOURCE_USER/index.json,readwrite" >> $GITHUB_ENV
          VCPKG_ROOT=$(pwd)/vcpkg
          echo "PATH=$VCPKG_ROOT;$PATH" >> $GITHUB_ENV
          echo "VCPKG_ROOT=$VCPKG_ROOT" >> $GITHUB_ENV

      - name: ðŸŒ‹ Build
        run: |
          VCPKG_OPTIONS="--overlay-ports="${{ github.workspace }}/ports" --host-triplet=${{ matrix.triplet }} --triplet=${{ matrix.triplet }}  --x-buildtrees-root=${{ env.buildtrees }} --recurse"
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-duckdb
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-pip
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-pydantic
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-sip
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-numpy
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-psycopg
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-psycopg2
          ./vcpkg/vcpkg install $VCPKG_OPTIONS 'gdal[python]'
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-urllib3
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-markupsafe
          # ./vcpkg/vcpkg install $VCPKG_OPTIONS py-matplotlib
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-requests
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-isort
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-autopep8
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-flask
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-ephem \
            py-geographiclib \
            py-pip-system-certs \
            py-wrapt \
            py-waitress
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-attrs
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-beautifulsoup4
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-fiona
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-rasterio
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-shapely
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-jsonschema
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-networkx
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-pyproj
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-lxml
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-tzdata
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-bottleneck
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-numexpr
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-calamine
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-pyarrow
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-adbc-driver-manager
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-adbc-postgresql
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-adbc-sqlite
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-gast \
            py-beniget \
            py-pythran
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-scipy
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-pandas
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-pyogrio
          ./vcpkg/vcpkg install $VCPKG_OPTIONS py-geopandas

          # ./vcpkg/vcpkg install $VCPKG_OPTIONS py-pyqt6

      - name: ðŸ“‘ Upload logs
        uses: actions/upload-artifact@v4
        if: failure()
        with:
          name: logs-${{ matrix.triplet }}
          path: ${{ env.buildtrees }}/**/*.log
